{"version":3,"names":["auth_1","__importDefault","require","firestore_1","messaging_1","mobx_1","mobx_persist_store_1","constants_1","storageAdapter_1","exports","MessagingStore","makeAutoObservable","path","makePersistable","name","properties","storage","storageAdapter","fetchBusinesses","requestUserPermission","_ref","_asyncToGenerator2","default","authStatus","requestPermission","enabled","AuthorizationStatus","AUTHORIZED","PROVISIONAL","getToken","then","token","saveTokenToDatabase","onTokenRefresh","apply","arguments","_ref2","_currentUser","userUid","currentUser","uid","collection","doc","update","tokens","FieldValue","arrayUnion","e","captureException","_x","delTokenOnSignOut","_ref3","_currentUser2","arrayRemove","error"],"sources":["/Users/playra/leela/src/store/MessagingStore.ts"],"sourcesContent":["import auth from '@react-native-firebase/auth'\nimport firestore from '@react-native-firebase/firestore'\nimport messaging from '@react-native-firebase/messaging'\nimport { makeAutoObservable } from 'mobx'\nimport { makePersistable } from 'mobx-persist-store'\n\nimport { captureException } from '../constants'\nimport { storageAdapter } from './storageAdapter'\n\nexport const MessagingStore = makeAutoObservable({\n  path: ''\n})\n\nmakePersistable(MessagingStore, {\n  name: 'MessagingStore',\n  properties: ['path'],\n  storage: storageAdapter\n})\n\nconst fetchBusinesses = () => {\n  const requestUserPermission = async () => {\n    const authStatus = await messaging().requestPermission()\n    const enabled =\n      authStatus === messaging.AuthorizationStatus.AUTHORIZED ||\n      authStatus === messaging.AuthorizationStatus.PROVISIONAL\n\n    if (enabled) {\n      messaging()\n        .getToken()\n        .then((token) => {\n          return saveTokenToDatabase(token)\n        })\n\n      return messaging().onTokenRefresh((token) => {\n        saveTokenToDatabase(token)\n      })\n    }\n  }\n  requestUserPermission()\n}\n\nconst saveTokenToDatabase = async (token: string) => {\n  const userUid = auth().currentUser?.uid\n  try {\n    if (userUid) {\n      await firestore()\n        .collection('Profiles')\n        .doc(userUid)\n        .update({\n          tokens: firestore.FieldValue.arrayUnion(token)\n        })\n    }\n  } catch (e) {\n    captureException(e, 'saveTokenToDatabase')\n  }\n}\n\nconst delTokenOnSignOut = async () => {\n  const userUid = auth().currentUser?.uid\n  try {\n    const token = await messaging().getToken()\n    await firestore()\n      .collection('Profiles')\n      .doc(userUid)\n      .update({\n        tokens: firestore.FieldValue.arrayRemove(token)\n      })\n  } catch (error) {\n    captureException(error, 'delTokenOnSignOut')\n  }\n}\n\nexport { saveTokenToDatabase, fetchBusinesses, delTokenOnSignOut }\n"],"mappings":"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"}